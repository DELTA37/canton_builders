module Test where

import Daml.Script
import RealEstate
import DA.Assert (assertEq)

test : Script ()
test = do
  testHappy
  testTransferMustFailForNonOwner
  testMarketplaceFlow

testHappy : Script ()
testHappy = script do
  registrar <- allocateParty "Registrar"
  owner <- allocateParty "Owner"
  buyer <- allocateParty "Buyer"

  let meta = "{ \"address\": \"Baker St 221b\", \"rooms\": 3 }"

  cid <- submit registrar do
    createCmd RealEstate
      with
        registrar
        owner
        propertyId = "ID-1"
        address = "Baker St 221b"
        propertyType = "apartment"
        area = 72.5
        metaJson = meta
        status = Active
        history = []
        listed = False
        price = 500000.0
        currency = "USD"

  debug ("Created RealEstate", cid)

  cid2 <- submit owner do
    exerciseCmd cid (Transfer with newOwner = buyer)

  debug ("Transferred", cid2)

  cid3 <- submit buyer do
    exerciseCmd cid2 (UpdateMeta with newMetaJson = "{ \"address\": \"Baker St 221b\", \"rooms\": 4 }")

  debug ("Updated meta", cid3)

  mState <- queryContractId registrar cid3
  case mState of
    Some st -> assertEq st.history [owner]
    None -> abort "Expected contract to exist after update"

  pure ()

testTransferMustFailForNonOwner : Script ()
testTransferMustFailForNonOwner = script do
  registrar <- allocateParty "Registrar"
  owner <- allocateParty "Owner"
  intruder <- allocateParty "Intruder"

  cid <- submit registrar do
    createCmd RealEstate
      with registrar
           owner
           propertyId = "ID-FAIL-1"
           address = "Main St 1"
           propertyType = "house"
           area = 120.0
           metaJson = "{}"
           status = Active
           history = []
           listed = False
           price = 250000.0
           currency = "USD"

  submitMustFail registrar do
    exerciseCmd cid (Transfer with newOwner = intruder)

  pure ()

-- No archive tests here to keep ledger state simple in scripts.

testMarketplaceFlow : Script ()
testMarketplaceFlow = script do
  registrar <- allocateParty "Registrar"
  owner <- allocateParty "Seller"
  buyer <- allocateParty "Buyer"

  payCid <- submit buyer do
    createCmd Cash
      with issuer = owner
           owner = buyer
           currency = "USD"
           amount = 320000.0

  cid <- submit registrar do
    createCmd RealEstate
      with registrar
           owner
           propertyId = "ID-SALE-1"
           address = "Market St 7"
           propertyType = "loft"
           area = 80.0
           metaJson = "{}"
           status = Active
           history = []
           listed = False
           price = 300000.0
           currency = "USD"

  cidListed <- submit owner do
    exerciseCmd cid (ListForSale with newPrice = 320000.0, newCurrency = "USD")

  cidBought <- submitMulti [owner, buyer] [buyer]
    (exerciseCmd cidListed (Buy with offeredPrice = 320000.0, offeredCurrency = "USD", buyer, paymentCid = payCid))

  mState <- queryContractId registrar cidBought
  case mState of
    Some st -> do
      assertEq st.owner buyer
      assertEq st.listed False
      assertEq st.history [owner]
    None -> abort "Expected contract to exist after buy"

  pure ()
